name: Release

on:
  workflow_dispatch:
    inputs:
      release-version:
        description: 'Release version (e.g., 0.2.0)'
        required: true
        type: string
      next-version:
        description: 'Next development version (e.g., 0.3.0-SNAPSHOT)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tags
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Validate version format
      run: |
        if ! echo "${{ inputs.release-version }}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
          echo "Error: Invalid release version format. Expected X.Y.Z"
          exit 1
        fi
        if ! echo "${{ inputs.next-version }}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+-SNAPSHOT$'; then
          echo "Error: Invalid next version format. Expected X.Y.Z-SNAPSHOT"
          exit 1
        fi

    - name: Check if tag exists
      run: |
        if git tag -l | grep -q "^v${{ inputs.release-version }}$"; then
          echo "Error: Tag v${{ inputs.release-version }} already exists"
          exit 1
        fi

    - name: Set release version
      run: |
        mvn versions:set -DnewVersion=${{ inputs.release-version }} -q
        find . -name "*.versionsBackup" -delete

    - name: Update README.md with release version
      run: |
        sed -i "s/<version>[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*\(-SNAPSHOT\)\{0,1\}<\/version>/<version>${{ inputs.release-version }}<\/version>/g" README.md

    - name: Commit release version
      run: |
        git add .
        git commit -m "Release version ${{ inputs.release-version }}"

    - name: Create and push release tag
      run: |
        git tag "v${{ inputs.release-version }}" -m "Release version ${{ inputs.release-version }}"
        git push origin "v${{ inputs.release-version }}"

    - name: Build and verify release
      run: |
        mvn clean verify -q

    - name: Import GPG key
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        echo "$GPG_PRIVATE_KEY" | base64 -d | gpg --batch --import
        echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf

    - name: Deploy to Maven Central
      env:
        SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        # Install parent POM
        mvn clean install -N -q

        # Build and install dependencies
        mvn clean install -pl pojodiff-spi,pojodiff-core -q

        # Deploy pojodiff-jackson to Maven Central
        mvn clean deploy -pl pojodiff-jackson -am -P release-signing \
          -Dgpg.passphrase="${GPG_PASSPHRASE}" \
          --batch-mode --no-transfer-progress

    - name: Set next development version
      run: |
        mvn versions:set -DnewVersion=${{ inputs.next-version }} -q
        find . -name "*.versionsBackup" -delete

    - name: Commit next development version
      run: |
        git add .
        git commit -m "Prepare for next development iteration ${{ inputs.next-version }}"
        git push origin main

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ inputs.release-version }}
        name: Release ${{ inputs.release-version }}
        body: |
          ## Release ${{ inputs.release-version }}

          ### Maven Dependency

          ```xml
          <dependency>
            <groupId>io.github.pojotools</groupId>
            <artifactId>pojodiff-jackson</artifactId>
            <version>${{ inputs.release-version }}</version>
          </dependency>
          ```

          ### Links

          - [Maven Central](https://central.sonatype.com/artifact/io.github.pojotools/pojodiff-jackson/${{ inputs.release-version }})
          - [Changelog](https://github.com/pojotools/pojodiff/blob/main/docs/CHANGELOG.md)
          - [Documentation](https://github.com/pojotools/pojodiff/blob/main/README.md)

          Release artifacts will be available on Maven Central within 30 minutes.
        draft: false
        prerelease: false
        generate_release_notes: true
